<!DOCTYPE html>
<html lang="en" ng-app="App">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js" type="text/javascript"></script>

<meta charset="utf-8"></meta>
<meta name="viewport" content="width=device-width, initial-scale=1"></meta>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous"></link>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>

<script src="./utils.js" type="text/javascript"></script>
<script src="./rest.js" type="text/javascript"></script>
<script src="./bindings.js" type="text/javascript"></script>
<script type="text/javascript">
// GLOBAL_Application is defined in bindings.js.
GLOBAL_Application.controller('AppController', function($scope)
{
	API_getXsrf().then(function() {
		xsrfLoaded($scope)
	});
});
function xsrfLoaded($scope)
{
	let hashArg = readGetVar("elt");
	$scope.elementHash = hashArg;
	// We start by loading it without caching and merely present the option in the case where it isn't cached.
	API_getPost($scope.elementHash, false).then(elt => {
		postWasLoaded($scope, elt);
	});
	setupEnvironment($scope);
}
function postWasLoaded($scope, elt)
{
	$scope.name = elt["name"];
	$scope.publisherKey = elt["publisherKey"];
	$scope.readableDate = new Date(elt["publishedSecondsUtc"] * 1000).toLocaleString();
	$scope.discussionUrl = elt["discussionUrl"];
	$scope.replyTo = elt["replyTo"];
	$scope.discussionHost = null;
	if (null !== $scope.discussionUrl)
	{
		// If this is an invalid URL, we don't want to break the page.
		try
		{
			$scope.discussionHost = new URL($scope.discussionUrl).hostname;
		}
		catch (e)
		{
			$scope.discussionHost = "(invalid URL)";
		}
	}
	$scope.cached = elt["cached"];
	$scope.isForcingCache = false;
	
	// We don't use Angular for the description since we may need to process it.
	let descriptionElement = document.getElementById("description");
	renderLongTextIntoElement(descriptionElement, elt["description"]);
	
	if ($scope.cached)
	{
		$scope.thumbnailUrl = elt["thumbnailUrl"];
		$scope.videoUrl = elt["videoUrl"];
		$scope.audioUrl = elt["audioUrl"];
		if (null !== $scope.videoUrl)
		{
			// The version of Angular we are using doesn't support the video tag so do this, ourselves.
			let v = document.getElementById("video");
			v.src = $scope.videoUrl;
			if (null != $scope.thumbnailUrl)
			{
				v.poster = $scope.thumbnailUrl;
			}
		}
		if (null !== $scope.audioUrl)
		{
			// The version of Angular we are using doesn't support the audio tag so do this, ourselves.
			let a = document.getElementById("audio");
			a.src = $scope.audioUrl;
		}
	}
	
	// We need to get the public key to see if we made this post.
	// Then, we need to check that user's info to see if this is the feature.
	$scope.isOurPost = false;
	$scope.isFeature = false;
	REST.GET("/home/channels")
		.then((response) => response.json())
		.then((data) => {
			// See which user is selected (could be none of them).
			let publicKey = null;
			for (let user of data)
			{
				if (user["isSelected"])
				{
					publicKey = user["publicKey"];
				}
			}
			$scope.isOurPost = ($scope.publisherKey === publicKey);
			if ($scope.isOurPost)
			{
				GLOBAL_UnknownUserLoader.loadTuple(publicKey).then(userInfo => {
					$scope.isFeature = (userInfo.feature === $scope.elementHash);
					$scope.$apply();
				});
			}
			$scope.$apply();
		});
	$scope.setAsFeature = function()
	{
		REST.POST("/home/userInfo/feature/" + $scope.publisherKey + "/" + $scope.elementHash)
			.then(function() {
				$scope.isFeature = true;
				$scope.$apply();
			})
		;
	}
	
	$scope.$apply();
}

function setupEnvironment($scope)
{
	// We will also store information around whether or not this is in the favourites list but we need to load that information so set it to null while uncertain.
	$scope.isFavourite = null;
	REST.GET("/favourites/list")
		.then(data => data.json())
		.then(hashArray => {
			$scope.isFavourite = false;
			for (let hash of hashArray)
			{
				if ($scope.elementHash === hash)
				{
					$scope.isFavourite = true;
					break;
				}
			}
			$scope.$apply();
		});
	$scope.addFavourite = function(post)
	{
		// We will just act like this immediately completed.
		$scope.isFavourite = true;
		REST.POST("/favourites/add/" + $scope.elementHash);
	}
	$scope.deleteFavourite = function(post)
	{
		// We will just act like this immediately completed.
		$scope.isFavourite = false;
		REST.DELETE("/favourites/remove/" + $scope.elementHash);
	}
	$scope.populateCache = function()
	{
		$scope.isForcingCache = true;
		// Force cache, this time.
		API_getPost($scope.elementHash, true).then(elt => {
			postWasLoaded($scope, elt);
		});
	}
	$scope.postReply = function()
	{
		// We want to send them over to the publish page with a URL parameter to create a new draft.
		window.location.href = "publish.html?replyTo=" + $scope.elementHash;
	}
	
	$scope.$apply();
}
</script>

	<title>Cacophony - Play Video</title>
</head>
<body ng-controller="AppController">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<div class="container">
		<a class="navbar-brand" href="https://github.com/jmdisher/Cacophony">Cacophony</a>
		<ul class="navbar-nav">
			<li class="nav-item"><a class="nav-link" href="index.html">Index</a></li>
			<li class="nav-item"><a class="nav-link" href="prefs.html">Preferences</a></li>
			<li class="nav-item"><a class="nav-link" href="user.html">This User</a></li>
			<li class="nav-item"><a class="nav-link" href="recommending.html">Recommended Users</a></li>
			<li class="nav-item"><a class="nav-link" href="following.html">Users you Follow</a></li>
			<li class="nav-item"><a class="nav-link" href="favourites.html">Favourites</a></li>
			<li class="nav-item"><a class="nav-link" href="replies.html">Replies</a></li>
			<li class="nav-item"><a class="nav-link" href="publish.html">Publish or Create Draft</a></li>
			<li class="nav-item"><a class="nav-link" href="status.html">Server Status</a></li>
		</ul>
	</div>
</nav>
<div class="container">
	<div class="jumbotron">
		<div class="row card card-body" ng-show="cached && (null !== videoUrl)">
			<center><video id="video" controls /></center>
		</div>
		<div class="row card card-body" ng-show="cached && (null !== audioUrl)">
			<center><audio id="audio" controls /></center>
		</div>
		<div class="row card card-body" ng-show="cached && (null !== thumbnailUrl) && (null === videoUrl)">
			<img class="img-responsive" ng-src="{{thumbnailUrl}}" alt="{{name}}"/>
		</div>
		<div class="row card card-body" ng-hide="cached">
			<strong>NOTE:  This entry is not cached locally so any images or videos associated with it cannot be viewed.</strong><br />
			<button class="btn btn-success" ng-disabled="isForcingCache" ng-click="populateCache()">Populate Cache</button><br />
		</div>
		<div class="row card card-body">
			<strong>{{name}}</strong><br />
			<span>Posted by <caco-user-link public-key="publisherKey"></caco-user-link> <em>({{readableDate}})</em></span><br />
			<span ng-show="null !== replyTo">Reply to:  <caco-post-small cid="replyTo"></caco-post-small></span><br />
		</div>
	</div>
	<div class="row justify-content-md-center">
		<div class="col-md-6">
			<div class="row card card-body" id="description">
			</div>
			<div class="row card card-body" ng-show="discussionUrl">
				<a ng-href="{{discussionUrl}}">View discussion on {{discussionHost}}</a>
			</div>
			<div class="btn-group" ng-show="true === isFavourite">
				<button class="btn btn-sm btn-danger dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Remove from favourites</button>
				<ul class="dropdown-menu"><li><a class="dropdown-item" ng-click="deleteFavourite()">Confirm</a></li></ul>
			</div>
			<div class="btn-group" ng-show="false === isFavourite">
				<button class="btn btn-sm btn-danger dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Add to favourites</button>
				<ul class="dropdown-menu"><li><a class="dropdown-item" ng-click="addFavourite()">Confirm</a></li></ul>
			</div>
			<button type="button" class="btn btn-sm btn-success" ng-click="postReply()">Post a Reply</button>
			<div class="btn-group" ng-show="isOurPost && !isFeature">
				<button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Set as feature post</button>
				<ul class="dropdown-menu"><li><a class="dropdown-item" ng-click="setAsFeature()">Confirm</a></li></ul>
			</div>
			<div ng-show="isOurPost && isFeature">
				Note that this is the feature post on your profile.
			</div>
		</div>
	</div>
</div>
</body>
</html>

