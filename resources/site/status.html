<!DOCTYPE html>
<html lang="en" ng-app="App">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js" type="text/javascript"></script>

<meta charset="utf-8"></meta>
<meta name="viewport" content="width=device-width, initial-scale=1"></meta>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous"></link>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>

<script src="./rest.js" type="text/javascript"></script>
<script src="./generated_db.js" type="text/javascript"></script>
<script type="text/javascript">
function stopServer(onComplete)
{
	REST.POST("/stop")
		.then(data => data.text())
		.then(onComplete);
}


// We will create an Angular controller and populate it with data from generated_db.js.
var GLOBAL_Application = angular.module('App', []);
GLOBAL_Application.controller('AppController', function($scope)
{
	$scope.serverState = "RUNNING";
	$scope.canPressStop = true;
	$scope.states = [];
	$scope.stopServer = function()
	{
		$scope.canPressStop = false;
		stopServer(function(text){
			$scope.serverState = "STOPPED";
			$scope.$apply();
		});
	}
	
	// NOTE:  We need to call this "cookie" page to set the cookie to defeat some XSRF cases (we mostly rely on SameSite to make this safe).
	API_getXsrf().then(function() {
		// Now that we have the XSRF, open the status event WebSocket.
		let statusSocket = new WebSocket("ws://127.0.0.1:8000/backgroundStatus", "status");
		statusSocket.onopen = function()
		{
			console.log("Status listener open");
		}
		statusSocket.addEventListener('message', function(event)
		{
			let object = JSON.parse(event.data);
			if ('ENQUEUE' == object.event)
			{
				// This is being added to the list.
				$scope.states.push(object);
			}
			else if ('START' == object.event)
			{
				// This is already in the list, so just update the state (and nothing else).
				let elt = $scope.states.find(function(value, index, array)
				{
					return (value.number == object.number);
				});
				elt.event = object.event;
			}
			else if ('END' == object.event)
			{
				// Remove this from the list.
				$scope.states = $scope.states.filter(function(elt)
				{
					return (elt.number != object.number);
				});
			}
			else
			{
				console.log("unknown event type: " + object.event);
			}
			$scope.$apply();
		});
		statusSocket.onclose = function(e)
		{
			console.log("Status listener closed");
			$scope.serverState = "Status closed: " + e.reason;
			$scope.states = [];
			$scope.$apply();
		}
	});
});

</script>

	<title>Cacophony - Server Status</title>
</head>
<body ng-controller="AppController">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
	<div class="container">
		<a class="navbar-brand" href="https://github.com/jmdisher/Cacophony">Cacophony</a>
		<ul class="navbar-nav">
			<li class="nav-item"><a class="nav-link" href="index.html">Index</a></li>
			<li class="nav-item"><a class="nav-link" href="prefs.html">Preferences</a></li>
			<li class="nav-item"><a class="nav-link" href="user.html">This User</a></li>
			<li class="nav-item"><a class="nav-link" href="recommending.html">Recommended Users</a></li>
			<li class="nav-item"><a class="nav-link" href="following.html">Users you Follow</a></li>
			<li class="nav-item"><a class="nav-link" href="publish.html">Publish or Create Draft</a></li>
			<li class="nav-item"><a class="nav-link active" href="status.html">Server Status</a></li>
		</ul>
	</div>
</nav>
<div class="container">
	<div class="row">
		<div class="card card-body col-md-3">
			<div class="row"><a class="btn" href="index.html">Index</a></div>
			<div class="row"><a class="btn" href="prefs.html">Preferences</a></div>
			<div class="row"><a class="btn" href="user.html">This User</a></div>
			<div class="row"><a class="btn" href="recommending.html">Recommended Users</a></div>
			<div class="row"><a class="btn" href="following.html">Users you Follow</a></div>
			<div class="row"><a class="btn" href="publish.html">Publish or Create Draft</a></div>
			<div class="row"><a class="btn" href="status.html">Server Status</a></div>
		</div>
		<div class="col-md-9">
			<div class="row card card-body">
				Server is {{serverState}}:  <button class="btn btn-danger" ng-enabled="canPressStop" ng-click="stopServer()">STOP SERVER</button><br/>
			</div>
			<div class="row card card-body" ng-repeat="state in states">
				<span class="badge rounded-pill text-bg-primary" ng-show="state.event === 'ENQUEUE'">Waiting</span>
				<span class="badge rounded-pill text-bg-success" ng-show="state.event === 'START'">Running</span>
				{{state.description}}
			</div>
		</div>
	</div>
</div>
</body>
</html>

