<!DOCTYPE html>
<html lang="en" ng-app="App">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js" type="text/javascript"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script>

<script src="./generated_db.js" type="text/javascript"></script>
<script type="text/javascript">
function GET(path)
{
	return fetch("http://127.0.0.1:8000" + path, {
		method: "GET",
	});
}

function POST(path)
{
	return fetch("http://127.0.0.1:8000" + path, {
		method: "POST",
	});
}

function POST_asForm(path, variables)
{
	let formParts = [];
	for (let property in variables) {
		let encodedKey = encodeURIComponent(property);
		let encodedValue = encodeURIComponent(variables[property]);
		formParts.push(encodedKey + "=" + encodedValue);
	}
	let formBody = formParts.join("&");
	return fetch("http://127.0.0.1:8000" + path, {
		method: "POST",
		headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
		body: formBody,
	});
}

function DELETE(path)
{
	return fetch("http://127.0.0.1:8000" + path, {
		method: "DELETE",
	});
}

function stopServer()
{
	POST("/stop")
		.then(data => data.text())
		.then(text => console.log(text));
}

function saveDraft(selectedDraft)
{
	let variables = {
		"title": selectedDraft.title,
		"description": selectedDraft.description,
	};
	if (null != selectedDraft.discussionUrl)
	{
		variables["discussionUrl"] = selectedDraft.discussionUrl;
	}
	return POST_asForm("/draft/" + selectedDraft.id, variables);
}


// We will create an Angular controller and populate it with data from generated_db.js.
var GLOBAL_Application = angular.module('App', []);
GLOBAL_Application.controller('AppController', function($scope)
{
	$scope.drafts = null;
	$scope.selectedDraft = null;
	$scope.inProgress = false;
	$scope.publishInProgress = false;
	
	$scope.videoConfig = {
		height: 720,
		width: 1280,
		fps: 15,
		stream: null,
		
		videoKilobits: 256,
		audioKilobits: 64,
		recorder: null,
		
		recompressionCommand: "ffmpeg -i -  -c:v libvpx-vp9 -b:v 256k -filter:v fps=15 -c:a libopus -b:a 32k -f webm  -",
		processingSocket: null,
		finalProcessed: 0,
	};
	
	$scope.selectDraft = function(draft)
	{
		$scope.selectedDraft = draft;
	}
	$scope.createNewDraft = function()
	{
		POST("/createDraft")
			.then(data => data.json())
			.then(draftObject => {
				$scope.drafts.push(draftObject);
				$scope.selectedDraft = draftObject;
				$scope.$apply();
			});
	}
	$scope.deleteDraft = function(draft)
	{
		DELETE("/draft/" + draft.id)
			.then(data => {
				if ((null !== $scope.selectedDraft) && ($scope.selectedDraft.id === draft.id))
				{
					$scope.selectedDraft = null;
				}
				$scope.drafts = $scope.drafts.filter((element, index, array) => {
					return (element.id !== draft.id);
				});
				$scope.$apply();
			});
	}
	$scope.saveDraft = function()
	{
		$scope.inProgress = true;
		saveDraft($scope.selectedDraft)
			.then(data => {
				$scope.inProgress = false;
				$scope.$apply();
			});
	}
	$scope.publish = function()
	{
		$scope.inProgress = true;
		$scope.publishInProgress = true;
		// We need to save-back the draft before publishing since the server publishes from the saved state.
		saveDraft($scope.selectedDraft).then(function(data) {
			// Now, begin the publish.
			POST("/draft/publish/" + $scope.selectedDraft.id)
				.then(function(data) {
					$scope.drafts = $scope.drafts.filter(elt => elt !== $scope.selectedDraft);
					$scope.selectedDraft = null;
					$scope.inProgress = false;
					$scope.publishInProgress = false;
					$scope.$apply();
				});
		});
	}
	
	GET("/drafts")
		.then(data => data.json())
		.then(json => {
			$scope.drafts = json;
			$scope.$apply();
		});
});

</script>

	<title>Cacophony - Static Index</title>
	<meta charset="utf-8"></meta>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"></link>
</head>
<body ng-controller="AppController">
<nav class="navbar navbar-inverse">
	<ul class="nav navbar-nav">
		<li><a class="navbar-link" href="index.html">Index</a></li>
		<li><a class="navbar-link" href="prefs.html">Preferences</a></li>
		<li><a class="navbar-link" href="user.html">This User</a></li>
		<li><a class="navbar-link" href="recommending.html">Recommended Users</a></li>
		<li><a class="navbar-link" href="following.html">Users you Follow</a></li>
	</ul>
</nav>
<div class="container">
	<div class="row">
		<div class="well col-md-3">
			<div class="row"><a class="btn" href="index.html">Index</a></div>
			<div class="row"><a class="btn" href="prefs.html">Preferences</a></div>
			<div class="row"><a class="btn" href="user.html">This User</a></div>
			<div class="row"><a class="btn" href="recommending.html">Recommended Users</a></div>
			<div class="row"><a class="btn" href="following.html">Users you Follow</a></div>
		</div>
		<div class="well col-md-6">
			<em ng-show="null == drafts">Loading drafts...</em>
			<div class="row" ng-show="null != drafts">Drafts ({{drafts.length}}):<br />
				<ul>
					<li ng-repeat="draft in drafts"><button class="btn btn-sm btn-danger" ng-click="deleteDraft(draft)">Delete</button> <a ng-click="selectDraft(draft)">{{draft.title}}</a></li>
				</ul>
			</div>
		</div>
		<div class="well col-md-3">
			<button class="btn btn-danger" onClick="stopServer()">STOP SERVER</button><br/>
			<button class="btn btn-small btn-success" ng-click="createNewDraft()" ng-disabled="inProgress">New Draft</button><br />
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<div class="well" ng-show="null == selectedDraft">
				Select a draft to see details.
			</div>
			<div class="well" ng-show="null != selectedDraft">
				Draft:  <strong>{{selectedDraft.title}}</strong>.<br />
				<div class="well">
					Title: <input type="text" class="form-control" ng-model="selectedDraft.title"></input><br />
					<textarea class="form-control" ng-model="selectedDraft.description" rows="4" maxlength="2000"></textarea><br />
					Discussion URL: <button class="btn btn-small" ng-click="selectedDraft.discussionUrl = ''" ng-show="null == selectedDraft.discussionUrl">Add Discussion URL</button>
					<input type="text" class="form-control" ng-model="selectedDraft.discussionUrl" ng-show="null != selectedDraft.discussionUrl"></input><br />
					<button class="btn btn-success" ng-click="saveDraft()" ng-disabled="inProgress">Save Draft</button>
					<button class="btn btn-danger" ng-click="publish()" ng-disabled="publishInProgress">Publish</button>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>

